<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>GI Demola</title>
    <script src="lib/OpenLayers.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    
    <!--<script src="lib/Firebug/firebug.js"></script>-->
    
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="style.css" type="text/css"> 
    <link rel="stylesheet" href="theme/default/style.css" type="text/css">
    <link rel="stylesheet" href="demola.css" type="text/css">
<script type="text/javascript">

    var map;
    var layer_array   = [];
    var control_array = [];
    var Task = $('#Task');    
    var Vad  = $('#Vad');
    var När  = $('När');
    

    var alert_style = new OpenLayers.Style({
        'fillColor': '#b61a1e',
        'fillOpacity': .2,
        'strokeColor': '#FF0000',
        'strokeWidth': 1,
        'pointRadius': 8,
      }); 
    var vehicle_style = new OpenLayers.Style({
        'fillColor': '#00ff00',
        'fillOpacity': .8,
        'strokeColor': '#aaee77',
        'strokeWidth': 3,
         'pointRadius': 8
      });
    var people_style = new OpenLayers.Style({
        'fillColor': '#0000ff',
        'fillOpacity': .8,
        'strokeColor': '#aaee77',
        'strokeWidth': 3,
         'pointRadius': 8,
         symbolizer: {
              externalGraphic: "img/marker-blue.png"
          } 
      });
    var info_style = new OpenLayers.Style({
        'fillColor': '#f0f30',
        'fillOpacity': .8,
        'strokeColor': '#aaee77',
        'strokeWidth': 3,
        'pointRadius': 8
    });

    var alert_style_map = new OpenLayers.StyleMap({
           'default': alert_style
    });

    


    var vehicle_style_map = new OpenLayers.StyleMap({
           'default': vehicle_style
    });
    var people_style_map = new OpenLayers.StyleMap({
           'default': people_style
    });
    var info_style_map = new OpenLayers.StyleMap({
           'default': info_style
    });
    
    var featAdded = function(){
                var d = new Date(); // for now
                console.log(this.List);
                //Sätter marker beroende på vilken typ !
                //this.that.features[0].style.externalGraphic = "'img/Eld.png'";
                if($('#Vad').val()==1){
                  //this.that.features[this.featureVectorLength-1].st
                }
                this.that.features[this.featureVectorLength-1].attributes = { Vem: $("#Vem").val(),
                                                                    Time: (d.getMonth()+1)+'-'+d.getDate()+'-'+d.getHours()+':'+d.getMinutes()+':'+d.getSeconds(), 
                                                                    Vad: $("#Vad").val(),
                                                                    Hur: $("#Hur").val(),
                                                                    Var: $("#Var").val()
                };
                this.that.redraw(true); 
                $('#dialog').dialog('close');
                $(""+this.List+"").hide();   
              

    }

function init(){
      //Functions block 
      //map functions
      var map_event_function = function(){
				        console.log('Klickar på kartan');
                map.layers[0].setOpacity(0.3);
      }
      var selectfunction = function(evt){
            console.log(evt.feature.id);

      }
      function readTextFile(file){
                var rawFile = new XMLHttpRequest();
                rawFile.open("GET", file, true);
                rawFile.onreadystatechange = function (){
                if(rawFile.readyState === 4){
                        if(rawFile.status === 200 || rawFile.status == 0){
                var allText = rawFile.responseText;
                var obj = JSON.parse(allText);
                console.log(obj);
                        }
                }
              }
              rawFile.send(null);
      }    
	    //Layer block
	    
		var featureSelected = function(evt){
            var feature = evt.feature;
            var popup = new OpenLayers.Popup.Anchored("geo_popup",
              feature.geometry.getBounds().getCenterLonLat(),
              null,
              null,
              null,
              true
            );
            //popup.setOpacity(0.8); 
            popup.setContentHTML("<div class=PopUpContent>"+"Tid : "+evt.feature.attributes.Time+" <br>" + " Vem : "+evt.feature.attributes.Vem+" "+"</div>");  
            feature.popup = popup;

            map.addPopup(popup);
          }
    var featureUnSelected = function(evt){
						var feature = evt.feature;
						map.removePopup(feature.popup);
						feature.popup.destroy();
						feature.popup = null;
		}
    //Button block
		//Då knappen är aktiv som så lyssnar man på kartans eventlistener !
    //Create a function for the toggle button
    
    var toggle_button_activate_func = function(){
                console.log('toggle_button_activate_func');
                //Attach the map_event_function to the map
                map.events.register('click', map, map_event_function);
                //map.events.register('click', layer, map_event_function);
    }
    
    //Tar bort eventlistener
    var toggle_button_deactivate_func = function(){
				        console.log('toggle_button_deactivate_func');
                //Remove the map_event_function from the map
                map.events.unregister('click', map, map_event_function);
                //Restore the layer's opacity
                map.layers[0].setOpacity(1);
    }
	//Panel block
  //--------------------------------------------------------End Functions block------------------------------------------------
  //---------------------------------------------------------------------------------------------------------------------------         
	//--------------------------------------------------------Start Content block------------------------------------------------
  //---------------------------------------------------------------------------------------------------------------------------          
  //Map block
  map = new OpenLayers.Map( 'map', {
				    eventListeners: {
                    "moveend": mapEvent,
                    "zoomend": mapEvent,
                    "changelayer": mapLayerChanged,
                    "changebaselayer": mapBaseLayerChanged}});         
  //Layer block
  layer = new OpenLayers.Layer.OSM("Karta");
  var areaOneLayer = new OpenLayers.Layer.Vector('Area One Layer',{
				eventListeners:{
					"featureselected":featureSelected,
					"featureunselected":featureUnSelected
				}});
  areaOneLayer.styleMap = alert_style_map;

  var areaTwoLayer = new OpenLayers.Layer.Vector('Area Two Layer',{
        eventListeners:{
          "featureselected":featureSelected,
          "featureunselected":featureUnSelected
        }});
  areaTwoLayer.styleMap = alert_style_map;
	
  var assetLayer = new OpenLayers.Layer.Vector('Tillgång Layer',{
				eventListeners:{
					"featureselected":featureSelected,
					"featureunselected":featureUnSelected
				}});
    assetLayer.styleMap = info_style_map;
	
  var personLayer = new OpenLayers.Layer.Vector('Person Layer',{
        eventListeners:{ 
					"featureselected":featureSelected,
					"featureunselected":featureUnSelected
				}});
    personLayer.styleMap = people_style_map;
	
  var vehicleLayer = new OpenLayers.Layer.Vector('Vehicle Layer',{
				eventListeners:{
					"featureselected":featureSelected,
					"featureunselected":featureUnSelected	
				}});
	


  vehicleLayer.styleMap = vehicle_style_map;
  
  map.addLayer(layer);    		
	map.addLayer(areaOneLayer);
	map.addLayer(areaTwoLayer);
	map.addLayer(assetLayer);
	map.addLayer(personLayer);
  map.addLayer(vehicleLayer);
	

			/*            
			var selector = new OpenLayers.Control.SelectFeature([vectorLayer, alertLayer, infoLayer, vehicleLayer, peopleLayer],{
				hover:false,
				toggle:true,
				autoActivate:true
			});
			*/
  var lonlat = new OpenLayers.LonLat(125.01085281372072,11.243735509183928).transform( new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));
  map.setCenter(lonlat);
  map.zoomTo(13);

  //Format object for reading fromfiles !
  //Create a Format object
  var geojson_layer = new OpenLayers.Layer.Vector("GeoJSON", {
            projection: "EPSG:4326",
            strategies: [new OpenLayers.Strategy.Fixed()],
            protocol: new OpenLayers.Protocol.HTTP({
                url: "data.json",
                format: new OpenLayers.Format.GeoJSON()
            }),
            eventListeners:{
          "featureselected":function(evt){
            var feature = evt.feature;

            var popup = new OpenLayers.Popup.Anchored("geo_popup",
              feature.geometry.getBounds().getCenterLonLat(),
              null,
              null,
              null,
              true
            );      
            feature.popup = popup;

            map.addPopup(popup);
          },
          "featureunselected":function(evt){
            var feature = evt.feature;
            map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
          }
        }
        });
      geojson_layer.styleMap = vehicle_style_map;
      
      map.addLayer(geojson_layer);
			
      var selector = new OpenLayers.Control.SelectFeature([ areaOneLayer, areaTwoLayer, vehicleLayer,personLayer ,assetLayer,geojson_layer],{
        hover:false,
        toggle:true,
        autoActivate:true
      });
      

      //Button block
			var b1 = new OpenLayers.Control.Button({
				trigger: function(){//Toggle visibility of submenubuttons
					$(".button2ItemInactive").toggle();
					$(".button2ItemActive").toggle();
					$(".button3ItemInactive").toggle();
					$(".button3ItemActive").toggle();
					$(".userButtonItemInactive").toggle();
					$(".userButtonItemActive").toggle();
					$(".layersButtonItemInactive").toggle();
					$(".layersButtonItemActive").toggle();
				},
				displayClass: "button1"
			});
			
			var b2 = new OpenLayers.Control.Button({
				trigger: function(){},
				displayClass: "button2"
			});
			
			var b3 = new OpenLayers.Control.Button({
				trigger: function(){},
				displayClass: "button3"
			});
			 
			var userButton = new OpenLayers.Control.Button({
				displayClass: "userButton"
			});
			 
			var layersButton = new OpenLayers.Control.Button({
				trigger: function(){
            console.log("Layers är triggat");

        },
        displayClass: "layersButton"

			})
	  
			var layerButton = new OpenLayers.Control.Button({
				displayClass: "button4"
			});

			var mapButton = new OpenLayers.Control.Button({
				displayClass: "button5",
				eventListeners: {
					"activate": toggle_button_activate_func,
					"deactivate": toggle_button_deactivate_func
				},
				type: OpenLayers.Control.TYPE_TOGGLE
			});
			
			
			//Panel block
			var vButtonPanel = new OpenLayers.Control.TextButtonPanel({
				vertical: true,
				additionalClass: "vButtonPanel"
			});
			var topLeftPanel = new OpenLayers.Control.TextButtonPanel({
				additionalClass:"topLeftPanel"
			});
			var drawPanel = new OpenLayers.Control.TextButtonPanel({
				vertical: true,
				additionalClass: "drawPanel"
			});
    
      topLeftPanel.addControls([mapButton, layerButton]);
			vButtonPanel.addControls([b1, b2, b3, layersButton, userButton]);
      
      //Layer part 
      function mapEvent(event){
                console.log(event.type);
      }
      function mapBaseLayerChanged(event) {
                console.log(event.type );
      }
      function mapLayerChanged(event) {
                console.log(event.type + " " + event.layer.name + " " + event.property);
      }

	  var drawMoveButton = new OpenLayers.Control.Button({
		  displayClass: "drawMoveButton",
		  trigger: function(){
			 drawPointAsset.deactivate();
			 drawPolygonAreaOne.deactivate();
			 drawPointPerson.deactivate();
		  }
	  });
    var drawPointAsset = new OpenLayers.Control.DrawFeature(assetLayer,OpenLayers.Handler.Point,
	{'displayClass':'drawPointAsset',
      featureAdded:function(){
        $("#assetList").show();
        $("#vehicleList").hide();
        $("#personList").hide();
     
         var List = "assetList";
         var LayerName = this.layer.name;
         var currentLayer = this.map.getLayersByName(LayerName);
         //get the first layer !
         var featureVectorLength = currentLayer[0].features.length;
         var that = this.layer;
         $("#dialog").dialog({
            buttons:{
              //Binder that och featureVectorLength till featAdded funktionen 
              Add: featAdded.bind({that:that,featureVectorLength:featureVectorLength,List:List})
            },
            open:function(){
           
            map.layers[0].setOpacity(0.3);
            },
            close:function(){
            map.layers[0].setOpacity(1.0);
            }
       });

        
      }});
    var drawPointPerson = new OpenLayers.Control.DrawFeature(personLayer,OpenLayers.Handler.Point,
	{'displayClass':'drawPointPerson',
      featureAdded:function(){
        $("#assetList").hide();
        $("#vehicleList").hide();
        $("#personList").show();
         var List = "personList";
         var LayerName = this.layer.name;
         var currentLayer = this.map.getLayersByName(LayerName);
         //get the first layer !
         var featureVectorLength = currentLayer[0].features.length;
         var that = this.layer;
         $("#dialog").dialog({
            buttons:{
              //Binder that och featureVectorLength till featAdded funktionen 
              Add: featAdded.bind({that:that,featureVectorLength:featureVectorLength,List:List})
            },
            open:function(){
           
            map.layers[0].setOpacity(0.3);
            },
            close:function(){
            map.layers[0].setOpacity(1.0);
            }
       });

        
      }});


    var drawPolygonAreaOne = new OpenLayers.Control.DrawFeature(areaOneLayer, OpenLayers.Handler.Polygon,
	{'displayClass':'drawPolygonAreaOne',
        featureAdded:function(){
         //Shit solution,but i works !!!
         var LayerName = this.layer.name;
         var currentLayer = this.map.getLayersByName(LayerName);
         //get the first layer !
         var featureVectorLength = currentLayer[0].features.length;
         var that = this.layer;
         $("#dialog").dialog({
            buttons:{
              Add: featAdded.bind({that:that,featureVectorLength:featureVectorLength})
          },
          open:function(){
           
            map.layers[0].setOpacity(0.3);
          },
          close:function(){
            map.layers[0].setOpacity(1.0);
          }
         });
    }});
    //Draw point functions
	  drawPanel.addControls(drawPointAsset);
    drawPanel.addControls(drawPointPerson);
    //drawPanel.addControls(drawPointVehicle);

	  drawPanel.addControls(drawPolygonAreaOne);
	  drawPanel.addControls(drawMoveButton);
   
		map.addControl(vButtonPanel);
		map.addControl(topLeftPanel);
		map.addControl(drawPanel);
		//Choose layer to add features
			
		//map.addControl(new OpenLayers.Control.EditingToolbar(vectorLayer));
		/*map.addControl(alertEditToolbar);
		map.addControl(infoEditToolbar);
		map.addControl(vehicleEditToolbar);
		map.addControl(peopleEditToolbar);*/
		map.addControl(selector);


			//Submenubuttons start hidden
	     
			$(".button2ItemInactive").hide();
			$(".button2ItemActive").hide();
			$(".button3ItemInactive").hide();
			$(".button3ItemActive").hide();
			$(".userButtonItemInactive").hide();
			$(".userButtonItemActive").hide();
			$(".layersButtonItemInactive").hide();
			$(".layersButtonItemActive").hide();
      //------------------------------------------
      $("#dialog").hide();
      $("#vehicleList").hide();
      $("#personList").hide();
      $("#assetList").hide();

    }
</script>
  </head>
<body onload="init()"> 
  <div id="map" class="smallmap olMap" ><style='width: 500px; height: 500px; '></div>
<div id ="output"></div>
  <div id="dialog" class="dialog" title="Add task"><style='z-index: 800px;'>
    <ul>
      <li>
      Vem <input type="textfield"id="Vem"/>
      </li>
      <li>
      Vad <input type="textfield"id="Vad"/>
      </li>
      <li>            
      Hur <input type="textfield" id="Hur"/>
      </li>
      <li>            
      Var <input type="textfield" id="Var"/>
      </li>
      <li>
      <select id="vehicleList">
          <option>Brandbil</option>
          <option>Helikopter</option>
      </select>
      <select id="personList">
          <option>Brandbil</option>
          <option>Volontär</option>
          <option>Sjukvård</option>
          <option>Brandledare</option>
          <option>Polis/Militär</option>
      </select>
      <select id="assetList">
          <option>Vattenpost</option>
      </select>
      </li>
      <li>
        <input type="radio" name="typ" value="Brukbar">  Brukbar<br>
        <input type="radio" name="typ" value="Obrukbar"> Obrukbar
      </li>
    </ul>  
</div>
   
  </body>
</html>
